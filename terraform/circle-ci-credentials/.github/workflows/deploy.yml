name: Deploy to S3

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  id-token: write   # Required for OIDC authentication
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # Only deploy on push to main, not on PRs
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build website
        run: npm run build
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: eu-west-1
          role-session-name: github-actions-${{ github.run_id }}
      
      - name: Deploy to S3
        run: |
          echo "Deploying to S3 bucket: petersouter.xyz"
          aws s3 sync dist/ s3://petersouter.xyz --delete --cache-control "max-age=31536000,public"
          
          # Set proper content types for common file types
          aws s3 cp s3://petersouter.xyz s3://petersouter.xyz --recursive --exclude "*" --include "*.html" --content-type "text/html" --cache-control "no-cache"
          aws s3 cp s3://petersouter.xyz s3://petersouter.xyz --recursive --exclude "*" --include "*.css" --content-type "text/css" --cache-control "max-age=31536000,public"
          aws s3 cp s3://petersouter.xyz s3://petersouter.xyz --recursive --exclude "*" --include "*.js" --content-type "application/javascript" --cache-control "max-age=31536000,public"
      
      - name: Invalidate CloudFront cache
        if: secrets.CLOUDFRONT_DISTRIBUTION_ID != ''
        run: |
          echo "Invalidating CloudFront cache..."
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"
      
      - name: Deployment complete
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "Website URL: https://petersouter.xyz"
