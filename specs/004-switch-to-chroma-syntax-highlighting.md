# Spec 004: Switch to Chroma Syntax Highlighting

## Summary

Replace the client-side highlight.js syntax highlighting with Hugo's built-in Chroma server-side highlighter, eliminating external JavaScript dependencies and improving page load performance.

## Motivation

The site currently uses highlight.js loaded from CDN, plus two additional CDN-loaded language packs (Terraform via `@taga3s/highlightjs-terraform` and Gherkin). This means:

- **3 external JS requests** per page with syntax highlighting
- **Client-side rendering** delays -- code blocks are unstyled until JS loads and executes
- **CDN dependency** on `cdn.jsdelivr.net` -- if the CDN is slow or down, syntax highlighting breaks
- **No RSS support** -- highlight.js requires JavaScript, so code in RSS feeds is unstyled
- **Custom registration code** -- `layouts/partials/foot_end.html` contains error-handling boilerplate for registering the Terraform language

Hugo's built-in Chroma highlighter renders syntax highlighting at build time into static HTML+CSS, eliminating all of these issues.

## Current State

**`config.toml:120`:**
```toml
syntaxHighlighter = "highlight.js"
```

**`layouts/partials/foot_end.html` (29 lines):**
- Loads Terraform language from `cdn.jsdelivr.net/npm/@taga3s/highlightjs-terraform@1.0.6`
- Loads Gherkin language from `cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1`
- Contains JavaScript error-handling for language registration

**Theme's `head.html`** partial loads the core highlight.js library and CSS when `syntaxHighlighter` is set to `"highlight.js"`.

## Proposed Changes

### 1. Update Hugo config

Remove the highlight.js param and add Chroma configuration:

```diff
- syntaxHighlighter = "highlight.js"
+ syntaxHighlighter = ""
```

Add a new markup section:

```toml
[markup.highlight]
  codeFences = true
  guessSyntax = true
  lineNos = false
  noClasses = false
  style = "dracula"
```

Setting `noClasses = false` means Chroma outputs CSS classes rather than inline styles, allowing the stylesheet to control the look.

### 2. Generate Chroma CSS

```bash
hugo gen chromastyles --style=dracula > static/css/syntax.css
```

Popular style options include `monokai`, `dracula`, `github`, `solarized-dark`, `nord`. Preview them at https://xyproto.github.io/splash/docs/.

### 3. Include the CSS in the head

Add to `layouts/partials/head_end.html`:

```html
<link rel="stylesheet" href="{{ "css/syntax.css" | relURL }}">
```

### 4. Simplify `layouts/partials/foot_end.html`

Remove the entire highlight.js block (all 29 lines). The file becomes empty or can be removed if no other content exists.

### 5. Verify language support

Chroma natively supports both languages that required custom CDN loading:

| Language | Chroma Lexer | Aliases |
|---|---|---|
| Terraform/HCL | `hcl` | `terraform`, `tf`, `hcl` |
| Gherkin | `gherkin` | `cucumber`, `behat` |

Fenced code blocks in posts will work with the same language hints:

````markdown
```terraform
resource "aws_s3_bucket" "example" {
  bucket = "my-bucket"
}
```

```gherkin
Feature: Login
  Scenario: Successful login
    Given I am on the login page
```
````

## Files Affected

| File | Change |
|---|---|
| `config.toml` / `hugo.toml` | Remove `syntaxHighlighter` param, add `[markup.highlight]` |
| `layouts/partials/foot_end.html` | Remove all highlight.js loading code |
| `layouts/partials/head_end.html` | Add Chroma CSS `<link>` |
| `static/css/syntax.css` | New file -- generated by `hugo gen chromastyles` |

## Effort Estimate

Medium -- approximately 1 hour including style selection and visual testing across posts with code blocks.

## Risks

- **Visual differences**: Chroma's color schemes differ from highlight.js themes. The exact colors will change, but this is cosmetic and can be tuned by choosing a different `--style` or editing the generated CSS.
- **Language detection**: Chroma's auto-detection (`guessSyntax = true`) may classify some unlabeled code blocks differently than highlight.js. Posts with fenced code blocks that specify a language (`` ```ruby ``, `` ```bash ``, etc.) are unaffected.
- **Theme interaction**: The tranquilpeak theme conditionally loads highlight.js based on the `syntaxHighlighter` param. Setting it to `""` or removing it should prevent the theme from loading highlight.js. This needs verification.

## Validation

```bash
# Generate the CSS
hugo gen chromastyles --style=dracula > static/css/syntax.css

# Build and check a post with code blocks
hugo server

# Verify no highlight.js scripts in the output
grep -r "highlight.js\|hljs" public/ | head

# Check specific language rendering
# Visit posts with Terraform, Gherkin, Ruby, Bash, Go code blocks

# Verify RSS feeds contain highlighted code
curl -s http://localhost:1313/feed.xml | grep "<code"
```

## References

- [Hugo Syntax Highlighting Docs](https://gohugo.io/content-management/syntax-highlighting/)
- [Chroma Style Gallery](https://xyproto.github.io/splash/docs/)
- [Chroma Supported Languages](https://github.com/alecthomas/chroma#supported-languages)
